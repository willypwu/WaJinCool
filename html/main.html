<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">

<style>
    tr {border:1px solid black;} 
    td {border:1px solid black; height: 25px; background-color:t; color: white}
    table {border-collapse:collapse; width: 100%; height: 100vh}
    li {color: white}
    
    /* The Modal (background) */
    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1; 
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto; /* Enable scroll if needed */
        background-color: rgb(0,0,0); /* Fallback color */
        background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
    }

    /* Modal Content/Box */
    .modal-content {
        background-color: #fefefe;
        margin: 15% auto; /* 15% from the top and centered */
        padding: 20px;
        border: 1px solid #888;
        width: 80%; /* Could be more or less, depending on screen size */
    }

    /* The Close Button */
    .op_record_dia_close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .op_record_dia_close:hover,
    .op_record_dia_close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
    
     #separator {
         width:100%;
         height:1px;
         background-color:#A7FFEB;
     }
    
    html {
        height: 100%;
        width:100%;
        margin: 0; 
        padding: 0;
    }
        
    body {
        background-image: url("/static/background.jpg");
        background-repeat: no-repeat;
        background-size:     cover;
        height: 100%;
        width:100%;
        margin: 0; 
        padding: 0;
    }
    
</style>
    
<head>
    <title>Wa! Jin-Cool</title>
    <link rel="stylesheet" href="../static/css/pikaday.css">
    <script>
        function init() {
            initOperateRecordDialog();
            initTable();          
        }
      
        function initOperateRecordDialog() {
            // Get the modal
            var operateRecordDialog = document.getElementById('operateRecordDialog');

            // Get the <span> element that closes the modal
            var span = document.getElementsByClassName('op_record_dia_close')[0];

            // When the user clicks on <span> (x), close the modal
            span.onclick = function() {
                operateRecordDialog.style.display = "none";
            }

            // When the user clicks anywhere outside of the modal, close it
//            window.onclick = function(event) {
//                if (event.target == operateRecordDialog) {
//                    operateRecordDialog.style.display = "none";
//                }
//            }
            operateRecordDialog.style.display = "none";
        }
      
        function initTable() {
            var table = document.createElement('table');
            table.id='records'
            table.style.height='auto';
          
            var tr = document.createElement('tr');  
            var td1 = document.createElement('td');
            td1.innerHTML="日期";
            td1.style.backgroundColor = "#00BCD4";
            td1.style.color = "black"
            td1.style.height="auto";
            var td2 = document.createElement('td');
            td2.style.backgroundColor = "#00BCD4";
            td2.style.color = "black"
            td2.style.height="auto";
            td2.innerHTML="金額";
            var td3 = document.createElement('td');
            td3.style.backgroundColor = "#00BCD4";
            td3.style.color = "black"
            td3.style.height="auto";
            td3.innerHTML="分類";
            var td4 = document.createElement('td');
            td4.style.backgroundColor = "#00BCD4";
            td4.style.color = "black"
            td4.style.height="auto";
            td4.innerHTML="備註";
                
            tr.appendChild(td1);
            tr.appendChild(td2);
            tr.appendChild(td3);
            tr.appendChild(td4);

            table.appendChild(tr);
            document.getElementById("record_area").appendChild(table);
          
            requestAllRecords();
        }
      
        function requestAllRecords() {
            // get All for init
            httpRequest = new XMLHttpRequest();
            httpRequest.onreadystatechange = function() {
                if (httpRequest.readyState == 4) {
                    if (httpRequest.status === 200) {                      
                        var result = JSON.parse(httpRequest.responseText);
                      
                        document.getElementById('user_name').innerHTML = result.user
                        
                        var table = document.getElementById('records');
                      
                        var content = result.content;
                        for (var i = 0; i < result.count; i++) {
                            // Create an empty <tr> element and add it to the 1st position of the table:
                            var num = table.rows.length;
                            var row = table.insertRow(num);

                            // Insert new cells (<td> elements) at the 1st and 2nd position of the "new" <tr> element:

                            row.insertCell(0).innerHTML = content[i].date;
                            row.insertCell(1).innerHTML = content[i].cost;
                            row.insertCell(2).innerHTML = content[i].category;
                            row.insertCell(3).innerHTML = content[i].comment; 
                            row.key=content[i].id;
                            (function(i) {
                                row.ondblclick = function() {
                                    tableRowClick(content[i].id);
                                }
                            })(i);
                        }
                    }
                }
            }
            httpRequest.open('GET', '/moneyHandle');
            httpRequest.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            httpRequest.send();          
        }
      
        function tableRowClick(id) {
            openRecordDialog();
              
            var table = document.getElementById("records");
            for (var i = 0, row; row = table.rows[i]; i++) {
                if (row.key == id) {
                    document.getElementById('dialogInputDate').value = row.cells[0].innerHTML;
                    document.getElementById('dialogInputCost').value = row.cells[1].innerHTML;
                    document.getElementById('dialogInputCategory').value = row.cells[2].innerHTML;
                    document.getElementById('dialogInputComment').value = row.cells[3].innerHTML;
                    // assign id to the dialog key attribute
                    document.getElementById('operateRecordDialog').key=row.key;
                }
            }
            document.getElementById('addRecordBtn').disabled=true;
            document.getElementById('modifyRecordBtn').disabled=false;
            document.getElementById('deleteRecordBtn').disabled=false;
        }
      
        function openRecordDialog() {
            var operateRecordDialog = document.getElementById('operateRecordDialog');
            operateRecordDialog.style.display = "block";
        }
      
        function closeRecordDialog() {
            var operateRecordDialog = document.getElementById('operateRecordDialog');
            operateRecordDialog.style.display = "none";
        }
      
        function newRecordData() {  
            openRecordDialog();
            document.getElementById('addRecordBtn').disabled=false;
            document.getElementById('modifyRecordBtn').disabled=true;
            document.getElementById('deleteRecordBtn').disabled=true;
        }
      
        function addRecordData() {          
            var params =
                "&date=" + document.getElementById('dialogInputDate').value + 
                "&cost=" + document.getElementById('dialogInputCost').value + 
                "&category=" + document.getElementById('dialogInputCategory').value +
                "&comment=" + document.getElementById('dialogInputComment').value;
          
            httpRequest = new XMLHttpRequest();
            httpRequest.onreadystatechange = function() {
                if (httpRequest.readyState == 4) {
                    if (httpRequest.status === 200) {
                        var result = JSON.parse(httpRequest.responseText);                      
                        var table = document.getElementById('records');
                        // Create an empty <tr> element and add it to the 1st position of the table:
                        var num = table.rows.length;
                        var row = table.insertRow(num);

                        // Insert new cells (<td> elements) at the 1st and 2nd position of the "new" <tr> element:
                        row.insertCell(0).innerHTML = result.date;
                        row.insertCell(1).innerHTML = result.cost;
                        row.insertCell(2).innerHTML = result.category;
                        row.insertCell(3).innerHTML = result.comment; 
                        row.key=result.id;
                        row.ondblclick = function() {
                            tableRowClick(result.id);
                        }
                    }
                }
            }
            httpRequest.open('POST', '/moneyHandle');
            httpRequest.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            httpRequest.send(params);
          
            closeRecordDialog();
        }
      
        function modifyRecordData() { 
            var currentKey = document.getElementById('operateRecordDialog').key
          
            var params =
                "&date=" + document.getElementById('dialogInputDate').value + 
                "&cost=" + document.getElementById('dialogInputCost').value + 
                "&category=" + document.getElementById('dialogInputCategory').value +
                "&comment=" + document.getElementById('dialogInputComment').value;
          
            httpRequest = new XMLHttpRequest();
            httpRequest.onreadystatechange = function() {
                if (httpRequest.readyState == 4) {
                    if (httpRequest.status === 200) {                      
                        var result = JSON.parse(httpRequest.responseText);
                        var table = document.getElementById("records");
                        for (var i = 0, row; row = table.rows[i]; i++) {
                            if (row.key == currentKey) {
                                row.cells[0].innerHTML = result.date;
                                row.cells[1].innerHTML = result.cost;
                                row.cells[2].innerHTML = result.category;
                                row.cells[3].innerHTML = result.comment; 
                                break;
                            }
                        }
                    }
                }
            }
            httpRequest.open('PUT', '/moneyHandle/' + currentKey);          
            httpRequest.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            httpRequest.send(params);
          
            closeRecordDialog();
        }
      
        function deleteRecordData() {  
            var currentKey = document.getElementById('operateRecordDialog').key          
            httpRequest = new XMLHttpRequest();
            httpRequest.onreadystatechange = function() {
                if (httpRequest.readyState == 4) {
                    if (httpRequest.status === 200) {                      
                        var result = JSON.parse(httpRequest.responseText);
                        var table = document.getElementById("records");
                        for (var i = 0, row; row = table.rows[i]; i++) {
                            if (row.key == currentKey) {
                                table.deleteRow(i);
                                break;
                            }
                        }
                    }
                }
            }
            httpRequest.open('DELETE', '/moneyHandle/' + currentKey);          
            httpRequest.send(); 
          
            closeRecordDialog();
        }
    </script>
</head>
    
<body onload="init()">
    <div id="container" style="height:100%;width:100%">        
        <div id="header" style="background-color:#009688;color:#FCFCFC;position:fixed;width:100%; top:0px; left:0px;height:135px">
            <div style="width:100%">
                <img src="/static/money.png" style="height:90px;width:150px;margin:3px;float:left">
                <h1 id="user_name" style="text-align:right;margin-bottom:0; padding-right:20px; font-size:100%;position:absolute;right:0;top:50px"></h1>
                <h1 style="text-align:center;margin-bottom:0;margin-top:0;font-size:45px;position:absolute;left:170px;top:20px">哇!!金庫</h1>
            </div>
            <div id="button_area" style="height:40px;width:100%;background-color:#FFf;margin-top:96px">
                <button id="newRecord" type="button" onclick="newRecordData()" 
                        style="margin-top:9px;margin-left:6px;background-color:#64FFDA;border: none;box-shadow: 1px 1px 5px #888888;">新增</button>
            </div>
        </div>
        
        <div id="content_area" style="width:100%;position:absolute;top:135px;bottom:25px">
            <div id="operateRecordDialog" class="modal">
                <!-- Modal content -->
                <div class="modal-content">
                    <div class="modal-header">
                        <span class="op_record_dia_close">x</span>
                        <h2 style="color:black">新增資料</h2>
                    </div>
                    <form style="color:black">
                        日期：
                        <input id="dialogInputDate" type="text" name="date">
                        <br />
                        金額：
                        <input id="dialogInputCost" type="text" name="cost">
                        <br />
                        分類：
                        <input id="dialogInputCategory" type="text" name="category">
                        <br />
                        備註：
                        <input id="dialogInputComment" type="text" name="comment">
                    </form>
                    <div class="modal-footer">
                        <button id="addRecordBtn" type="button" onclick=addRecordData()>儲存</button>
                        <button id="modifyRecordBtn"type="button" onclick=modifyRecordData()>修改</button>
                        <button id="deleteRecordBtn" type="button" onclick=deleteRecordData()>刪除</button>
                    </div>
                </div>
            </div>        
            <div id="info_area" style="background: rgba(0, 0, 0, .6);height:100%;width:35%;border: 1px solid black;box-sizing: border-box;float:left;overflow-y: auto;">
                <h1 style="text-align:center;background-color:#F44336;margin:0;height:80px;font-size:300%">相關資訊</h1>
                <ul>
                    <li>總收入:</li>
                    <li>總支出:</li>
                </ul>
            </div>
            <div id="record_area" style="background: rgba(0, 0, 0, .8);height:100%;width:65%;float:left;border: 1px solid black;box-sizing: border-box;overflow-y: auto;">
            </div>
        </div>

        <div id="footer" style="background-color:#FCFCFC;color:#4F4F4F;clear:both;text-align:center;position:fixed;bottom: 0px;width:100%">版權所有 © Willy Wu</div>
    </div>
    
    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.5.1/moment.min.js"></script>
    <script src="../static/js/pikaday.js"></script>
    <script>
        var picker = new Pikaday({
                field: document.getElementById('dialogInputDate'),
                firstDay: 1,    
                minDate: new Date(2000, 0, 1),
                maxDate: new Date(2020, 12, 31),
                yearRange: [2000,2020],
                reposition: false,
                onOpen: function() {
                this.el.style.top = document.getElementById('dialogInputDate').offsetTop;
                this.el.style.left = document.getElementById('dialogInputDate').offsetLeft;
                }});
    </script>
</body>
</html>
